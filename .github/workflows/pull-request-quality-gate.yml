# !!! WARNING !!! #
# This workflow is reused in all LDES Java projects. Edit with caution #
name: Pull Request Quality Gate
on:
  workflow_call:
    inputs:
      SETTINGS_FILE:
        required: false
        type: string
      SKIP_DOCKER:
        required: false
        type: string
    secrets:
      SDK_USERNAME:
        required: false
      SDK_PASSWORD:
        required: false
      SONAR_TOKEN:
        required: true
  workflow_dispatch:

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
      - name: Set up JDK 18
        uses: actions/setup-java@v3
        with:
          java-version: '18'
          distribution: 'adopt'
      - name: Cache SonarCloud packages
        uses: actions/cache@v1
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar
      - name: Cache Maven packages
        uses: actions/cache@v1
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2
      - name: Define Sonar Project Name
        uses: mad9000/actions-find-and-replace-string@1
        id: sonar-name
        with:
          source: ${{ github.repository }}
          find: '/'
          replace: '_'
      - name: Set Optional Maven Settings Variable
        if: ${{ inputs.SETTINGS_FILE != '' }}
        ## Reference your environment variables
        run: |
          echo "SETTINGS_ARG=--settings ${{ inputs.SETTINGS_FILE }}" >> $GITHUB_ENV
      - name: Build and analyze
        if: ${{ github.event.pull_request.head.repo.full_name == github.repository }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SDK_USERNAME: ${{ secrets.SDK_USERNAME }} # Temporary hack to get around PAT for github packages
          SDK_PASSWORD: ${{ secrets.SDK_PASSWORD }} # Temporary hack to get around PAT for github packages
        run: mvn ${{ env.SETTINGS_ARG  }} -B verify org.sonarsource.scanner.maven:sonar-maven-plugin:sonar -Dintegrationtestskip=true -Dsonar.projectKey=${{ steps.sonar-name.outputs.value  }} -Pcoverage
      - name: Build (Forks) # https://portal.productboard.com/sonarsource/1-sonarcloud/c/50-sonarcloud-analyzes-external-pull-request
        if: ${{ github.event.pull_request.head.repo.full_name != github.repository }}
        run: mvn -B verify -Dintegrationtestskip=true
      - name: Build Docker image
        if: ${{ inputs.SKIP_DOCKER != 'true' }}
        uses: docker/build-push-action@v3
        with:
          context: .
          push: false