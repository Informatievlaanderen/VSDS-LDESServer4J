version: "3.3"
services:
  ldes-server:
    container_name: basic_ldes-server
    build: .
    environment:
      - SPRING_CONFIG_LOCATION=/config/
      - PYROSCOPE_APPLICATION_NAME=ldes-server
      - PYROSCOPE_SERVER_ADDRESS=http://pyroscope:4040
      - PYROSCOPE_FORMAT=jfr
      - PYROSCOPE_PROFILING_INTERVAL=10ms
      - PYROSCOPE_PROFILER_EVENT=itimer
      - PYROSCOPE_PROFILER_LOCK=10ms
      - PYROSCOPE_PROFILER_ALLOC=512k
      - PYROSCOPE_UPLOAD_INTERVAL=15s
      - PYROSCOPE_LOG_LEVEL=debug
    volumes:
      - ./docker-compose/server.config.yml:/config/application.yml:ro
    ports:
      - 8080:8080
    networks:
      - ldes
    depends_on:
      - ldes-mongodb
  ldes-mongodb:
    container_name: ldes-mongodb
    image: mongo:6.0.4
    ports:
      - 27017:27017
    networks:
      - ldes

  pyroscope:
    image: grafana/pyroscope:latest
    ports:
      - 4040:4040
    networks:
      - ldes

  grafana:
    image: grafana/grafana:main
    ports:
      - 3000:3000
    environment:
      - GF_FEATURE_TOGGLES_ENABLE=flameGraph
    networks:
      - ldes
  jaeger:
    image: jaegertracing/all-in-one:1.37
    environment:
      - COLLECTOR_OTLP_ENABLED=true
    ports:
      - "6831:6831/udp"
      - "16686:16686"
      - "4319:4317"
      - "4320:4318"
      - "14250:14250"
networks:
  ldes:
